{% extends "base.html" %}
{% block title %}Nueva venta{% endblock %}
{% block content %}
<h1>Nueva venta</h1>
<form method="post">{% csrf_token %}
  <fieldset class="mb-3">
    <legend>Encabezado</legend>
    {{ form.as_p }}
  </fieldset>

  <fieldset class="mb-3">
    <legend>Detalles</legend>
    {{ formset.management_form }}
    <table class="table table-dark table-sm align-middle">
      <thead>
        <tr><th>Producto</th><th>Litros</th><th>Precio Unitario</th><th>Eliminar</th></tr>
      </thead>
      <tbody>
        {% for f in formset %}
          <tr>
            <td>{{ f.producto }}</td>
            <td>{{ f.litros }}</td>
            <td>{{ f.precio_unitario }}</td>
            <td>{% if f.instance.pk %}{{ f.DELETE }}{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="button" id="add-row" class="btn btn-outline-info btn-sm">Agregar l√≠nea</button>
  </fieldset>

  {# --- ERRORES VISIBLES --- #}
  {% if form.errors or form.non_field_errors %}
    <div class="alert alert-danger mt-3">
      {{ form.non_field_errors }}
      {{ form.errors }}
    </div>
  {% endif %}

  {% for f in formset.forms %}
    {% if f.errors or f.non_field_errors %}
      <div class="alert alert-danger mt-2">
        {{ f.non_field_errors }}
        {{ f.errors }}
      </div>
    {% endif %}
  {% endfor %}

  {% if formset.non_form_errors %}
    <div class="alert alert-danger mt-2">
      {{ formset.non_form_errors }}
    </div>
  {% endif %}

  <h4 class="mt-3">Total: Q <span id="total-live">0.00</span></h4>

  <div class="d-flex gap-2 mt-3">
    <button type="submit" class="btn btn-success">Guardar y confirmar</button>
    <a class="btn btn-outline-light" href="{% url 'tienda:venta_list' %}">Cancelar</a>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
 
  const preciosArr = JSON.parse('{{ precios_json|escapejs }}'); 
  const precios = {};
  for (const p of preciosArr) precios[String(p.id)] = String(p.precio_litro);

  function bindRow(row){
    const sel = row.querySelector("select[name$='-producto']");
    const litros = row.querySelector("input[name$='-litros']");
    const precio = row.querySelector("input[name$='-precio_unitario']");

    const setPrice = () => {
      const pid = sel?.value;
      if (pid && precios[pid] && precio) precio.value = precios[pid];
      recalcTotal();
    };

    sel && sel.addEventListener('change', setPrice);
    litros && litros.addEventListener('input', recalcTotal);
    precio && precio.addEventListener('input', recalcTotal);

    
    if (precio && !precio.value) setPrice();
  }

  function recalcTotal(){
    let tot = 0;
    document.querySelectorAll("tbody tr").forEach(tr=>{
      const l = parseFloat(tr.querySelector("input[name$='-litros']")?.value || 0);
      const p = parseFloat(tr.querySelector("input[name$='-precio_unitario']")?.value || 0);
      tot += l*p;
    });
    const el = document.getElementById("total-live");
    if (el) el.textContent = (Math.round(tot*100)/100).toFixed(2);
  }

  
  document.querySelectorAll('tbody tr').forEach(bindRow);
  recalcTotal();

 
  const addBtn = document.getElementById("add-row");
  addBtn && addBtn.addEventListener("click", ()=>{
    const totalInput = document.querySelector("input[name='det-TOTAL_FORMS']");
    const idx = parseInt(totalInput.value,10);
    const tbody = document.querySelector("tbody");
    const first = tbody.querySelector("tr");
    const clone = first.cloneNode(true);

    
    clone.querySelectorAll("input,select,label").forEach(el=>{
      if (el.name)     el.name = el.name.replace(/-(\d+)-/, `-${idx}-`);
      if (el.id)       el.id   = el.id.replace(/-(\d+)-/, `-${idx}-`);
      if (el.htmlFor)  el.htmlFor = el.htmlFor.replace(/-(\d+)-/, `-${idx}-`);

      if (el.tagName === "INPUT") {
        if (el.type === "checkbox" || el.type === "radio") el.checked = false;
        else el.value = "";
      }
      if (el.tagName === "SELECT") el.selectedIndex = 0;
    });

    tbody.appendChild(clone);
    totalInput.value = idx + 1;
    bindRow(clone);
  });
});
</script>
{% endblock %}
