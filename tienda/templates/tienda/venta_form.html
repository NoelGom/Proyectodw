{% extends "base.html" %}
{% block title %}Nueva venta{% endblock %}
{% block content %}
<h1>Nueva venta</h1>
<form method="post">{% csrf_token %}
  <fieldset class="mb-3">
    <legend>Encabezado</legend>
    {{ form.as_p }}
  </fieldset>

  <fieldset class="mb-3">
    <legend>Detalles</legend>
    {{ formset.management_form }}
    <table class="table table-dark table-sm align-middle">
      <thead>
        <tr><th>Producto</th><th>Litros</th><th>Precio Unitario</th><th>Eliminar</th></tr>
      </thead>
      <tbody>
        {% for f in formset %}
          <tr>
            <td>{{ f.producto }}</td>
            <td>{{ f.litros }}</td>
            <td>{{ f.precio_unitario }}</td>
            <td>{% if f.instance.pk %}{{ f.DELETE }}{% endif %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </fieldset>

  <div class="d-flex gap-2">
    <button class="btn btn-success">Guardar y confirmar</button>
    <a class="btn btn-outline-light" href="{% url 'tienda:venta_list' %}">Cancelar</a>
  </div>
</form>

<!-- JS: autocompletar precio por litro según producto -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Precios enviados desde la vista
  const preciosArr = JSON.parse('{{ precios_json|escapejs }}'); // [{id, precio_litro}, ...]
  const precios = {};
  for (const p of preciosArr) precios[String(p.id)] = String(p.precio_litro);

  function syncRow(row) {
    const sel = row.querySelector("select[name$='-producto']");
    const precio = row.querySelector("input[name$='-precio_unitario']");
    if (!sel || !precio) return;

    const setPrice = () => {
      const pid = sel.value;
      if (precios[pid]) precio.value = precios[pid];
    };

    sel.addEventListener('change', setPrice);

    // Si el precio está vacío al cargar, intenta autollenarlo
    if (!precio.value) setPrice();
  }

  document.querySelectorAll('tbody tr').forEach(syncRow);
});
</script>
{% endblock %}
